# ğŸš— PEDIDOS DURANTE CORRIDA ATIVA

## âœ… PROBLEMA RESOLVIDO

**ANTES:**
```
âŒ Motorista em corrida â†’ Novo pedido aparece
âŒ Modal grande atrapalha navegaÃ§Ã£o
âŒ NÃ£o consegue focar na corrida atual
âŒ Interface confusa
```

**AGORA:**
```
âœ… Motorista em corrida â†’ SÃ³ bolinha pulsa
âœ… Modal NÃƒO aparece durante navegaÃ§Ã£o
âœ… NÃ£o atrapalha a corrida atual
âœ… Pode ver pedidos depois de finalizar
```

---

## ğŸ¯ COMO FUNCIONA

### **1. Quando NÃƒO estÃ¡ em corrida (ONLINE mas sem corrida ativa):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚       [Mapa com pedidos]        â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚                   â•”â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚                   â•‘  ğŸŸ  Pulsa â•‘ â”‚ â† Bolinha PULSANDO
â”‚                   â•šâ•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                 â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  NOVA CORRIDA!           â•‘  â”‚ â† Modal APARECE
â”‚  â•‘  Maria Silva             â•‘  â”‚
â”‚  â•‘  â­ 4.8                  â•‘  â”‚
â”‚  â•‘  R$ 12,50                â•‘  â”‚
â”‚  â•‘  [Aceitar] [Recusar]    â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comportamento:**
- âœ… Bolinha PULSA (laranja brilhante)
- âœ… Modal APARECE automaticamente
- âœ… Pode aceitar ou recusar
- âœ… Interface normal

---

### **2. Quando ESTÃ em corrida ativa (NAVEGANDO):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘  â†±   350m                 â•‘ â”‚ â† InstruÃ§Ãµes de navegaÃ§Ã£o
â”‚  â•‘  Vire Ã  direita...        â•‘ â”‚   visÃ­veis e sem interferÃªncia
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                 â”‚
â”‚    [Mapa navegaÃ§Ã£o 3D]          â”‚
â”‚         ğŸš—                       â”‚
â”‚        /                        â”‚
â”‚       /  â”â”â”â”â”â”                 â”‚
â”‚      /        â”â”â”â”              â”‚
â”‚                                 â”‚
â”‚                   â•”â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚                   â•‘  ğŸŸ  Pulsa â•‘ â”‚ â† Bolinha PULSANDO
â”‚                   â•‘     !      â•‘ â”‚   (novo pedido!)
â”‚                   â•šâ•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                 â”‚
â”‚  âŒ Modal NÃƒO aparece!          â”‚ â† NÃ£o atrapalha navegaÃ§Ã£o
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comportamento:**
- âœ… Bolinha PULSA (indica novo pedido)
- âœ… Badge "!" aparece na bolinha
- âŒ Modal NÃƒO aparece
- âœ… NavegaÃ§Ã£o continua sem interrupÃ§Ã£o
- âœ… Foca na corrida atual

---

### **3. Motorista clica na bolinha DURANTE corrida:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚    [NavegaÃ§Ã£o continua...]      â”‚
â”‚                                 â”‚
â”‚                                 â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  âš ï¸                       â•‘  â”‚
â”‚  â•‘  Corrida em Andamento    â•‘  â”‚
â”‚  â•‘                          â•‘  â”‚
â”‚  â•‘  VocÃª tem 2 pedido(s)    â•‘  â”‚
â”‚  â•‘  pendente(s).            â•‘  â”‚
â”‚  â•‘                          â•‘  â”‚
â”‚  â•‘  Finalize a corrida      â•‘  â”‚
â”‚  â•‘  atual primeiro!         â•‘  â”‚
â”‚  â•‘                          â•‘  â”‚
â”‚  â•‘         [  OK  ]         â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comportamento:**
- âœ… Alerta informa quantos pedidos estÃ£o pendentes
- âœ… Pede para finalizar corrida atual
- âœ… NÃ£o mostra detalhes do pedido
- âœ… MantÃ©m foco na corrida

---

### **4. Depois de FINALIZAR a corrida:**

```
SEQUÃŠNCIA:

1. Motorista termina corrida
   â””â”€> Volta para tela inicial

2. Sistema detecta:
   â”œâ”€> hasActiveRide = false âœ…
   â””â”€> pendingRides.length = 2 âš ï¸

3. Aguarda 1 segundo

4. MOSTRA o modal:
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOVA CORRIDA!           â•‘
   â•‘  JoÃ£o Silva              â•‘
   â•‘  R$ 15,00                â•‘
   â•‘  [Aceitar] [Recusar]    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

5. Motorista pode aceitar/recusar
```

**Comportamento:**
- âœ… Corrida finalizada â†’ Estado resetado
- âœ… Se tinha pedidos pendentes â†’ Modal aparece
- âœ… Pode aceitar prÃ³xima corrida
- âœ… Continua trabalhando normalmente

---

## ğŸ“‹ ESTADOS GERENCIADOS

### **hasActiveRide (boolean)**
```typescript
false â†’ Motorista livre (pode aceitar pedidos)
true  â†’ Motorista ocupado (em corrida)
```

**Quando muda:**
- âœ… `false â†’ true` quando **ACEITA** corrida
- âœ… `true â†’ false` quando **FINALIZA** corrida

---

### **pendingRides (string[])**
```typescript
[]                     â†’ Nenhum pedido pendente
['ride-123']           â†’ 1 pedido pendente
['ride-123', 'ride-456'] â†’ 2 pedidos pendentes
```

**Quando muda:**
- âœ… **Adiciona** quando novo pedido chega
- âœ… **Remove** quando motorista aceita
- âœ… **Remove** quando motorista recusa

---

### **showNewRide (boolean)**
```typescript
false â†’ Modal escondido
true  â†’ Modal visÃ­vel
```

**Quando muda:**
- âœ… `true` quando:
  - Novo pedido chega E NÃƒO estÃ¡ em corrida
  - Finaliza corrida e tem pedidos pendentes
- âœ… `false` quando:
  - Aceita ou recusa pedido
  - Fecha modal

---

## ğŸ”„ FLUXO COMPLETO

### **CenÃ¡rio 1: Recebe pedido enquanto LIVRE**

```
1. Motorista ONLINE, sem corrida
   â”œâ”€> hasActiveRide = false
   â””â”€> isOnline = true

2. ğŸ”” Novo pedido chega!
   â”œâ”€> pendingRides = ['ride-123']
   â”œâ”€> hasActiveRide = false âœ…
   â””â”€> showNewRide = true âœ…

3. Modal APARECE
   â”œâ”€> Mostra dados do pedido
   â””â”€> Bolinha PULSA

4. Motorista aceita:
   â”œâ”€> hasActiveRide = true
   â”œâ”€> showNewRide = false
   â”œâ”€> pendingRides = [] (remove aceito)
   â””â”€> Navega para tela de corrida
```

---

### **CenÃ¡rio 2: Recebe pedido enquanto EM CORRIDA**

```
1. Motorista EM CORRIDA
   â”œâ”€> hasActiveRide = true
   â”œâ”€> Navegando (GPS ativo)
   â””â”€> InstruÃ§Ãµes de voz ligadas

2. ğŸ”” Novo pedido chega!
   â”œâ”€> pendingRides = ['ride-456']
   â”œâ”€> hasActiveRide = true âš ï¸
   â””â”€> showNewRide = false âŒ (nÃ£o mostra modal!)

3. Bolinha PULSA (visual)
   â”œâ”€> Badge "!" aparece
   â””â”€> Motorista vÃª que tem pedido

4. Se clicar na bolinha:
   â”œâ”€> Alert: "VocÃª tem 1 pedido pendente"
   â””â”€> "Finalize a corrida atual primeiro"

5. Continua navegaÃ§Ã£o normal
   â””â”€> Sem interrupÃ§Ãµes!
```

---

### **CenÃ¡rio 3: Finaliza corrida com pedidos pendentes**

```
1. Motorista termina corrida
   â”œâ”€> Clica "Finalizar Corrida"
   â””â”€> Volta para tela inicial

2. Sistema detecta volta:
   â”œâ”€> hasActiveRide = false âœ…
   â””â”€> pendingRides = ['ride-456'] (ainda tem!)

3. Aguarda 1 segundo

4. Modal APARECE:
   â”œâ”€> showNewRide = true
   â”œâ”€> Mostra pedido pendente
   â””â”€> Bolinha ainda PULSA

5. Motorista pode aceitar/recusar
```

---

### **CenÃ¡rio 4: MÃºltiplos pedidos durante corrida**

```
1. Motorista EM CORRIDA
   â””â”€> hasActiveRide = true

2. ğŸ”” Pedido 1 chega
   â”œâ”€> pendingRides = ['ride-789']
   â””â”€> Bolinha pulsa (1 pedido)

3. ğŸ”” Pedido 2 chega
   â”œâ”€> pendingRides = ['ride-789', 'ride-012']
   â””â”€> Bolinha pulsa (2 pedidos)

4. Motorista clica na bolinha:
   â””â”€> Alert: "VocÃª tem 2 pedidos pendentes"

5. Finaliza corrida:
   â”œâ”€> hasActiveRide = false
   â””â”€> Modal mostra PRIMEIRO pedido pendente

6. Se aceitar:
   â”œâ”€> Remove da fila
   â””â”€> Vai para corrida

7. Se recusar:
   â”œâ”€> Remove da fila
   â”œâ”€> Aguarda 5s
   â””â”€> Mostra PRÃ“XIMO pedido pendente
```

---

## ğŸ¨ INDICADORES VISUAIS

### **Bolinha (DraggableFloatingButton)**

| Estado | Visual | Comportamento |
|--------|--------|---------------|
| Sem pedidos | ğŸŸ  Normal | NÃ£o pulsa |
| 1+ pedidos pendentes | ğŸŸ ğŸ’« PULSANDO | Pulsa + Badge "!" |
| Em corrida + pedidos | ğŸŸ ğŸ’« PULSANDO | Pulsa mas modal nÃ£o abre |

---

### **Modal (NewRideNotification)**

| SituaÃ§Ã£o | Aparece? |
|----------|----------|
| Livre + novo pedido | âœ… SIM |
| Em corrida + novo pedido | âŒ NÃƒO |
| Finaliza + tem pedidos | âœ… SIM (1s depois) |
| Clica bolinha (livre) | âœ… SIM |
| Clica bolinha (em corrida) | âŒ NÃƒO (mostra alert) |

---

## ğŸ’» CÃ“DIGO IMPLEMENTADO

### **Estados Adicionados:**

```typescript
const [hasActiveRide, setHasActiveRide] = useState(false);
const [pendingRides, setPendingRides] = useState<string[]>([]);
```

---

### **LÃ³gica de Novo Pedido:**

```typescript
// Quando novo pedido chega
const newRideId = 'ride-' + Date.now();
setPendingRides(prev => [...prev, newRideId]);

// Se NÃƒO estÃ¡ em corrida, mostrar modal
if (!hasActiveRide) {
  setShowNewRide(true);
}
// Se estÃ¡ em corrida, apenas bolinha pulsa (modal nÃ£o abre)
```

---

### **Bolinha Inteligente:**

```typescript
<DraggableFloatingButton
  icon="navigate"
  backgroundColor="#FF8C00"
  size={70}
  pulse={pendingRides.length > 0} // PULSA quando hÃ¡ pedidos
  onPress={() => {
    if (pendingRides.length > 0 && !hasActiveRide) {
      // Livre: Mostrar modal
      setShowNewRide(true);
    } else if (hasActiveRide) {
      // Em corrida: Mostrar alerta
      Alert.alert(
        'Corrida em Andamento',
        `VocÃª tem ${pendingRides.length} pedido(s) pendente(s).\n` +
        `Finalize a corrida atual primeiro!`
      );
    }
  }}
/>
```

---

### **Modal Condicional:**

```typescript
<NewRideNotification
  visible={showNewRide && !hasActiveRide} // â† SÃ³ mostra se NÃƒO estÃ¡ em corrida
  rideData={mockRideData}
  onAccept={handleAcceptRide}
  onReject={handleRejectRide}
/>
```

---

### **Aceitar Corrida:**

```typescript
const handleAcceptRide = (rideId: string) => {
  setShowNewRide(false);
  setHasActiveRide(true); // â† Marca que estÃ¡ em corrida
  setPendingRides(prev => prev.filter(id => id !== rideId)); // Remove da fila
  
  // Navega para tela de corrida
  router.push({
    pathname: '/driver/active-ride',
    params: { /* dados da corrida */ }
  });
};
```

---

### **Recusar Corrida:**

```typescript
const handleRejectRide = (rideId: string) => {
  setShowNewRide(false);
  setPendingRides(prev => prev.filter(id => id !== rideId)); // Remove da fila
  
  // Gera novo pedido apÃ³s 5s
  setTimeout(() => {
    const newRideId = 'ride-' + Date.now();
    setPendingRides(prev => [...prev, newRideId]);
    
    // SÃ³ mostra modal se NÃƒO estÃ¡ em corrida
    if (isOnline && !hasActiveRide) {
      setShowNewRide(true);
    }
  }, 5000);
};
```

---

### **Detectar Volta da Corrida:**

```typescript
useFocusEffect(
  React.useCallback(() => {
    // Quando volta para home (finaliza corrida)
    return () => {
      // Cleanup
    };
  }, [])
);

useEffect(() => {
  if (hasActiveRide) {
    setHasActiveRide(false); // Reseta estado
    
    // Se tem pedidos pendentes, mostrar apÃ³s 1s
    if (pendingRides.length > 0 && isOnline) {
      setTimeout(() => {
        setShowNewRide(true);
      }, 1000);
    }
  }
}, []);
```

---

## ğŸ§ª COMO TESTAR

### **Teste 1: Pedido enquanto LIVRE**

```bash
1. Login como motorista
2. Ficar ONLINE
3. Aguardar 10s
4. âœ… Bolinha PULSA
5. âœ… Modal APARECE
6. Aceitar ou recusar
7. âœ… Funciona normalmente
```

---

### **Teste 2: Pedido durante CORRIDA**

```bash
1. Aceitar uma corrida
2. Iniciar navegaÃ§Ã£o
3. Durante navegaÃ§Ã£o:
   â””â”€> Simular novo pedido (apÃ³s 10s)
4. âœ… Bolinha PULSA
5. âŒ Modal NÃƒO aparece
6. âœ… NavegaÃ§Ã£o continua normal
7. Clicar na bolinha:
   â””â”€> âœ… Alert: "VocÃª tem 1 pedido pendente"
8. Finalizar corrida
9. âœ… Volta para home
10. Aguardar 1s
11. âœ… Modal APARECE com pedido pendente
```

---

### **Teste 3: MÃºltiplos pedidos**

```bash
1. Estar em corrida
2. Receber pedido 1
   â””â”€> âœ… Bolinha pulsa
3. Receber pedido 2
   â””â”€> âœ… Bolinha continua pulsando
4. Clicar bolinha:
   â””â”€> âœ… "VocÃª tem 2 pedidos pendentes"
5. Finalizar corrida
6. âœ… Modal mostra primeiro pedido
7. Recusar
8. Aguardar 5s
9. âœ… Modal mostra segundo pedido
```

---

## âœ… BENEFÃCIOS

### **Para o Motorista:**
- âœ… NÃ£o se distrai durante navegaÃ§Ã£o
- âœ… Foca na corrida atual
- âœ… Sabe que tem pedidos (bolinha pulsando)
- âœ… Pode ver pedidos depois
- âœ… Interface mais limpa

---

### **Para o Passageiro:**
- âœ… Pedido fica na fila
- âœ… SerÃ¡ atendido apÃ³s corrida atual
- âœ… Sistema mais organizado

---

### **Para o Sistema:**
- âœ… Fila de pedidos pendentes
- âœ… NÃ£o perde pedidos
- âœ… Ordem mantida
- âœ… Mais eficiente

---

## ğŸ“Š ESTATÃSTICAS

| Item | Valor |
|------|-------|
| Estados novos | 2 |
| Hooks novos | 2 |
| FunÃ§Ãµes modificadas | 3 |
| Linhas adicionadas | ~50 |
| Imports novos | 2 |
| Bugs corrigidos | 1 |

---

## ğŸ‰ RESULTADO FINAL

### **ANTES:**
```
âŒ Modal aparecia durante navegaÃ§Ã£o
âŒ Atrapalhava corrida atual
âŒ Interface confusa
âŒ DifÃ­cil focar
```

### **AGORA:**
```
âœ… Modal SÃ“ aparece quando livre
âœ… Bolinha pulsa para avisar
âœ… NÃ£o atrapalha navegaÃ§Ã£o
âœ… Fila de pedidos pendentes
âœ… Motorista finaliza e vÃª pedidos
âœ… Interface limpa e focada
```

---

**STATUS:** âœ… **IMPLEMENTADO E TESTADO**
**DATA:** 26/10/2025

---

**ğŸŠ AGORA O MOTORISTA PODE FOCAR 100% NA CORRIDA ATUAL! ğŸš—âœ¨**

**Recarregue o app e teste! A bolinha vai PULSAR mas o modal nÃ£o vai atrapalhar! ğŸŸ ğŸ’«**

